"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

require("core-js/modules/es.promise");

var _errors = require("./errors");

var _queryOptions = _interopRequireDefault(require("./query-options"));

var _resourceGetter = _interopRequireDefault(require("./resource-getter"));

class ResourceUpdater {
  constructor(model, params, newRecord) {
    this._model = model.unscoped();
    this._params = params;
    this._newRecord = newRecord;
  }

  async perform() {
    const queryOptions = new _queryOptions.default(this._model);
    await queryOptions.filterByIds([this._params.recordId]);
    const record = await this._model.findOne(queryOptions.sequelizeOptions);

    if (record) {
      Object.assign(record, this._newRecord);

      try {
        await record.validate();
        await record.save();
      } catch (error) {
        throw new _errors.ErrorHTTP422(error.message);
      }
    }

    return new _resourceGetter.default(this._model, {
      recordId: this._params.recordId
    }).perform();
  }

}

module.exports = ResourceUpdater;